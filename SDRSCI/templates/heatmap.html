{% extends "base.html" %}

{% block title %}US RFI Geographic Map - NRAO Spectrum Sentinels{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS for mapping -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 0.375rem;
        border: 1px solid #495057;
    }
    
    .map-container {
        position: relative;
        background: #1a1d20;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .map-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(13, 17, 23, 0.9);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #495057;
        z-index: 1000;
        min-width: 200px;
    }
    
    .legend {
        margin-top: 10px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        font-size: 0.85rem;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid #fff;
    }
    
    .astro-marker {
        background: #ff6b6b;
        border: 2px solid #fff;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
        animation: pulse-astro 2s infinite;
    }
    
    .interference-marker {
        background: #feca57;
        border: 2px solid #fff;
        border-radius: 50%;
        box-shadow: 0 0 8px rgba(254, 202, 87, 0.4);
    }
    
    .normal-marker {
        background: #48cae4;
        border: 2px solid #fff;
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(72, 202, 228, 0.3);
    }
    
    @keyframes pulse-astro {
        0% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 107, 107, 0.6); }
        50% { transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 107, 107, 0.8); }
        100% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 107, 107, 0.6); }
    }
    
    .leaflet-popup-content-wrapper {
        background: #1a1d20;
        color: #fff;
        border: 1px solid #495057;
    }
    
    .leaflet-popup-tip {
        background: #1a1d20;
        border: 1px solid #495057;
    }
    
    .summary-card {
        background: rgba(13, 17, 23, 0.9);
        border: 1px solid #495057;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .frequency-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-right: 5px;
        margin-bottom: 2px;
    }
    
    .astro-frequency {
        background: rgba(255, 107, 107, 0.2);
        color: #ff6b6b;
        border: 1px solid #ff6b6b;
    }
    
    .interference-frequency {
        background: rgba(254, 202, 87, 0.2);
        color: #feca57;
        border: 1px solid #feca57;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(13, 17, 23, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        border-radius: 0.375rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i data-feather="map" class="me-2"></i>
                        US Radio Frequency Interference Map
                    </h1>
                    <p class="text-muted mb-0">Real-time geographic visualization of RFI affecting radio astronomy</p>
                </div>
                <div class="d-flex gap-2">
                    <div class="real-time-indicator">
                        <span class="status-indicator status-online"></span>
                        <span>Live Data</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-2">
                            <label class="form-label">Time Range</label>
                            <select class="form-select" id="hours-filter" onchange="updateMap()">
                                <option value="1">Last Hour</option>
                                <option value="6">Last 6 Hours</option>
                                <option value="24" selected>Last 24 Hours</option>
                                <option value="168">Last Week</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Frequency Filter</label>
                            <select class="form-select" id="freq-filter" onchange="updateMap()">
                                <option value="all">All Frequencies</option>
                                <option value="radio_astronomy">Radio Astronomy Bands</option>
                                <option value="vhf">VHF (30-300 MHz)</option>
                                <option value="uhf">UHF (300-1000 MHz)</option>
                                <option value="l_band">L-Band (1-2 GHz)</option>
                                <option value="wifi">WiFi Bands</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Min Power (dB)</label>
                            <input type="number" class="form-control" id="min-power" value="-100" onchange="updateMap()">
                        </div>
                        <div class="col-md-2">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="astro-only">
                                <label class="form-check-label" for="astro-only">
                                    Radio Astronomy Only
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary" onclick="refreshMapData()">
                                <i data-feather="refresh-cw" class="me-1"></i>
                                Refresh
                            </button>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check form-switch mt-1">
                                <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                                <label class="form-check-label" for="auto-refresh">
                                    Auto-refresh
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map and Summary -->
    <div class="row">
        <div class="col-lg-9">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="radio" class="me-2"></i>
                        United States RFI Detection Map
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="map-container">
                        <div id="map"></div>
                        <div class="loading-overlay" id="map-loading">
                            <div class="text-center">
                                <div class="spinner-border text-info mb-3" role="status">
                                    <span class="visually-hidden">Loading map data...</span>
                                </div>
                                <div class="text-white">Loading RFI data...</div>
                            </div>
                        </div>
                        <div class="map-overlay">
                            <div class="text-white">
                                <h6 class="mb-3">
                                    <i data-feather="info" class="me-2"></i>
                                    Live Data Summary
                                </h6>
                                <div class="small" id="map-stats">
                                    <div>Total Detections: <span id="total-count">0</span></div>
                                    <div>Radio Astronomy: <span id="astro-count">0</span></div>
                                    <div>Interference: <span id="interference-count">0</span></div>
                                    <div>Last Updated: <span id="last-updated">Loading...</span></div>
                                </div>
                                <div class="legend">
                                    <h6 class="small mb-2">Legend:</h6>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #ff6b6b;"></div>
                                        Radio Astronomy Bands
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #feca57;"></div>
                                        General Interference
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #48cae4;"></div>
                                        Normal Signals
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3">
            <!-- Radio Astronomy Bands -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i data-feather="target" class="me-2"></i>
                        Protected Radio Astronomy Bands
                    </h6>
                </div>
                <div class="card-body">
                    <div class="small" id="astro-bands">
                        <div class="mb-2">
                            <strong>HI Line:</strong> 1420-1421 MHz
                            <div class="frequency-badge astro-frequency">Critical</div>
                        </div>
                        <div class="mb-2">
                            <strong>L-Band:</strong> 1400-1700 MHz
                            <div class="frequency-badge astro-frequency">Protected</div>
                        </div>
                        <div class="mb-2">
                            <strong>Continuum 74:</strong> 73-75 MHz
                        </div>
                        <div class="mb-2">
                            <strong>Continuum 150:</strong> 149-151 MHz
                        </div>
                        <div class="mb-2">
                            <strong>Continuum 325:</strong> 324-326 MHz
                        </div>
                        <div class="mb-2">
                            <strong>C-Band:</strong> 4800-5000 MHz
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Detections -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i data-feather="activity" class="me-2"></i>
                        Recent Detections
                    </h6>
                </div>
                <div class="card-body">
                    <div id="recent-detections" class="small">
                        <div class="text-muted text-center">
                            <i data-feather="clock" class="me-2"></i>
                            Loading recent data...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
let map;
let markersLayer;
let mapData = [];
let autoRefreshInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    setupAutoRefresh();
    
    // Load initial data
    refreshMapData();
    
    // Real-time updates
    if (window.realtimeClient) {
        window.realtimeClient.on('detection_progress', function(data) {
            if (data.latest_detection) {
                addRealtimeDetection(data.latest_detection);
            }
        });
        
        window.realtimeClient.on('processing_completed', function(data) {
            if (data.detections_found > 0) {
                setTimeout(refreshMapData, 2000);
            }
        });
    }

    // Filter change handlers
    document.getElementById('astro-only').addEventListener('change', updateMap);
});

function initializeMap() {
    // Initialize map centered on continental United States
    map = L.map('map', {
        center: [39.8283, -98.5795], // Geographic center of continental US
        zoom: 4,
        minZoom: 3,
        maxZoom: 12
    });

    // Add dark tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // Initialize markers layer
    markersLayer = L.layerGroup().addTo(map);
    
    // Set bounds to focus on continental US
    const southWest = L.latLng(25.0, -125.0);
    const northEast = L.latLng(49.0, -66.9);
    const bounds = L.latLngBounds(southWest, northEast);
    map.fitBounds(bounds);
}

function refreshMapData() {
    const hours = document.getElementById('hours-filter').value;
    const minPower = document.getElementById('min-power').value;
    const freqFilter = document.getElementById('freq-filter').value;
    const astroOnly = document.getElementById('astro-only').checked;
    
    document.getElementById('map-loading').style.display = 'flex';
    
    const params = new URLSearchParams({
        hours: hours,
        min_power: minPower,
        freq_filter: freqFilter,
        astro_only: astroOnly.toString()
    });
    
    fetch(`/api/heatmap_data?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mapData = data.data;
                updateMapVisualization();
                updateSummaryStats(data.summary);
                updateRecentDetections();
            } else {
                console.error('Error loading map data:', data.error);
            }
            document.getElementById('map-loading').style.display = 'none';
        })
        .catch(error => {
            console.error('Error fetching map data:', error);
            document.getElementById('map-loading').style.display = 'none';
        });
}

function updateMap() {
    refreshMapData();
}

function updateMapVisualization() {
    // Clear existing markers
    markersLayer.clearLayers();
    
    if (mapData.length === 0) {
        return;
    }
    
    // Group nearby points to avoid clutter
    const groupedData = groupNearbyPoints(mapData, 0.5); // 0.5 degree threshold
    
    groupedData.forEach(group => {
        const isAstro = group.items.some(item => item.is_radio_astronomy);
        const hasHighPower = group.items.some(item => item.power > -50);
        
        // Determine marker type and color
        let markerClass, markerSize, markerColor;
        if (isAstro) {
            markerClass = 'astro-marker';
            markerColor = '#ff6b6b';
            markerSize = hasHighPower ? 12 : 8;
        } else if (hasHighPower) {
            markerClass = 'interference-marker';
            markerColor = '#feca57';
            markerSize = 10;
        } else {
            markerClass = 'normal-marker';
            markerColor = '#48cae4';
            markerSize = 6;
        }
        
        // Create custom marker
        const marker = L.circleMarker([group.lat, group.lng], {
            radius: markerSize,
            fillColor: markerColor,
            color: '#fff',
            weight: 2,
            opacity: 0.9,
            fillOpacity: 0.7,
            className: markerClass
        });
        
        // Create popup content
        const popupContent = createPopupContent(group);
        marker.bindPopup(popupContent, {
            maxWidth: 300,
            className: 'dark-popup'
        });
        
        // Add click handler
        marker.on('click', function() {
            highlightDetectionGroup(group);
        });
        
        markersLayer.addLayer(marker);
    });
    
    // Update last updated time
    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
}

function groupNearbyPoints(data, threshold) {
    const groups = [];
    const processed = new Set();
    
    data.forEach((point, index) => {
        if (processed.has(index)) return;
        
        const group = {
            lat: point.latitude,
            lng: point.longitude,
            items: [point]
        };
        
        processed.add(index);
        
        // Find nearby points
        data.forEach((otherPoint, otherIndex) => {
            if (processed.has(otherIndex) || index === otherIndex) return;
            
            const distance = Math.sqrt(
                Math.pow(point.latitude - otherPoint.latitude, 2) +
                Math.pow(point.longitude - otherPoint.longitude, 2)
            );
            
            if (distance < threshold) {
                group.items.push(otherPoint);
                processed.add(otherIndex);
            }
        });
        
        // Calculate group center if multiple points
        if (group.items.length > 1) {
            group.lat = group.items.reduce((sum, item) => sum + item.latitude, 0) / group.items.length;
            group.lng = group.items.reduce((sum, item) => sum + item.longitude, 0) / group.items.length;
        }
        
        groups.push(group);
    });
    
    return groups;
}

function createPopupContent(group) {
    const item = group.items[0]; // Use first item for representative data
    const count = group.items.length;
    const astroCount = group.items.filter(i => i.is_radio_astronomy).length;
    const avgPower = group.items.reduce((sum, i) => sum + i.power, 0) / count;
    const freqRange = {
        min: Math.min(...group.items.map(i => i.frequency)),
        max: Math.max(...group.items.map(i => i.frequency))
    };
    
    let content = `
        <div class="text-white">
            <h6 class="mb-2">
                ${count > 1 ? `${count} Detections` : 'Detection'}
                ${item.location_info.city ? ` - ${item.location_info.city}` : ''}
                ${item.location_info.state ? `, ${item.location_info.state}` : ''}
            </h6>
    `;
    
    if (astroCount > 0) {
        content += `
            <div class="mb-2">
                <span class="frequency-badge astro-frequency">
                    ${astroCount} Radio Astronomy ${astroCount === 1 ? 'Detection' : 'Detections'}
                </span>
            </div>
        `;
    }
    
    content += `
            <div class="small">
                <div><strong>Frequency Range:</strong> ${freqRange.min.toFixed(1)} - ${freqRange.max.toFixed(1)} MHz</div>
                <div><strong>Average Power:</strong> ${avgPower.toFixed(1)} dB</div>
                <div><strong>Latest Detection:</strong> ${new Date(item.timestamp).toLocaleString()}</div>
    `;
    
    if (count > 1) {
        content += `<div><strong>Detection Count:</strong> ${count}</div>`;
    }
    
    if (item.astro_band) {
        content += `<div><strong>Astronomy Band:</strong> ${item.astro_band.replace('_', ' ').toUpperCase()}</div>`;
    }
    
    content += `
            </div>
        </div>
    `;
    
    return content;
}

function updateSummaryStats(summary) {
    document.getElementById('total-count').textContent = summary.total_detections.toLocaleString();
    document.getElementById('astro-count').textContent = summary.radio_astronomy_detections.toLocaleString();
    document.getElementById('interference-count').textContent = summary.interference_detections.toLocaleString();
}

function updateRecentDetections() {
    const recent = mapData
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 5);
    
    const container = document.getElementById('recent-detections');
    
    if (recent.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center">
                <i data-feather="info" class="me-2"></i>
                No recent detections
            </div>
        `;
        feather.replace();
        return;
    }
    
    container.innerHTML = recent.map(detection => `
        <div class="mb-3 pb-2 border-bottom border-secondary">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${detection.frequency.toFixed(1)} MHz</strong>
                    ${detection.is_radio_astronomy ? '<span class="frequency-badge astro-frequency">Astro</span>' : ''}
                </div>
                <small class="text-muted">${detection.power.toFixed(1)} dB</small>
            </div>
            <div class="small text-muted">
                ${detection.location_info.city || 'Unknown location'} • 
                ${new Date(detection.timestamp).toLocaleTimeString()}
            </div>
        </div>
    `).join('');
    
    feather.replace();
}

function addRealtimeDetection(detection) {
    // Add to mapData if not already present
    const exists = mapData.find(d => d.id === detection.id);
    if (!exists && detection.latitude && detection.longitude) {
        mapData.push(detection);
        
        // Update visualization if auto-refresh is disabled
        if (!document.getElementById('auto-refresh').checked) {
            updateMapVisualization();
            updateRecentDetections();
        }
    }
}

function highlightDetectionGroup(group) {
    console.log('Detection group details:', group);
}

function setupAutoRefresh() {
    const autoRefreshCheckbox = document.getElementById('auto-refresh');
    
    function toggleAutoRefresh() {
        if (autoRefreshCheckbox.checked) {
            autoRefreshInterval = setInterval(refreshMapData, 30000); // 30 seconds
        } else {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    }
    
    autoRefreshCheckbox.addEventListener('change', toggleAutoRefresh);
    toggleAutoRefresh(); // Initial setup
}
</script>
{% endblock %}